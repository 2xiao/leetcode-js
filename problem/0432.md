# [432. å…¨ O(1) çš„æ•°æ®ç»“æ„](https://leetcode.com/problems/all-oone-data-structure)

ğŸ”´ <font color=#ff334b>Hard</font>&emsp; ğŸ”–&ensp; [`è®¾è®¡`](/tag/design.md) [`å“ˆå¸Œè¡¨`](/tag/hash-table.md) [`é“¾è¡¨`](/tag/linked-list.md) [`åŒå‘é“¾è¡¨`](/tag/doubly-linked-list.md)&emsp; ğŸ”—&ensp;[`LeetCode`](https://leetcode.com/problems/all-oone-data-structure)

## é¢˜ç›®

<p>è¯·ä½ è®¾è®¡ä¸€ä¸ªç”¨äºå­˜å‚¨å­—ç¬¦ä¸²è®¡æ•°çš„æ•°æ®ç»“æ„ï¼Œå¹¶èƒ½å¤Ÿè¿”å›è®¡æ•°æœ€å°å’Œæœ€å¤§çš„å­—ç¬¦ä¸²ã€‚</p>

<p>å®ç° <code>AllOne</code> ç±»ï¼š</p>

<ul>
	<li><code>AllOne()</code> åˆå§‹åŒ–æ•°æ®ç»“æ„çš„å¯¹è±¡ã€‚</li>
	<li><code>inc(String key)</code> å­—ç¬¦ä¸² <code>key</code> çš„è®¡æ•°å¢åŠ  <code>1</code> ã€‚å¦‚æœæ•°æ®ç»“æ„ä¸­å°šä¸å­˜åœ¨ <code>key</code> ï¼Œé‚£ä¹ˆæ’å…¥è®¡æ•°ä¸º <code>1</code> çš„ <code>key</code> ã€‚</li>
	<li><code>dec(String key)</code> å­—ç¬¦ä¸² <code>key</code> çš„è®¡æ•°å‡å°‘ <code>1</code> ã€‚å¦‚æœ <code>key</code> çš„è®¡æ•°åœ¨å‡å°‘åä¸º <code>0</code> ï¼Œé‚£ä¹ˆéœ€è¦å°†è¿™ä¸ª <code>key</code> ä»æ•°æ®ç»“æ„ä¸­åˆ é™¤ã€‚æµ‹è¯•ç”¨ä¾‹ä¿è¯ï¼šåœ¨å‡å°‘è®¡æ•°å‰ï¼Œ<code>key</code> å­˜åœ¨äºæ•°æ®ç»“æ„ä¸­ã€‚</li>
	<li><code>getMaxKey()</code> è¿”å›ä»»æ„ä¸€ä¸ªè®¡æ•°æœ€å¤§çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæ²¡æœ‰å…ƒç´ å­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸² <code>""</code> ã€‚</li>
	<li><code>getMinKey()</code> è¿”å›ä»»æ„ä¸€ä¸ªè®¡æ•°æœ€å°çš„å­—ç¬¦ä¸²ã€‚å¦‚æœæ²¡æœ‰å…ƒç´ å­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ªç©ºå­—ç¬¦ä¸² <code>""</code> ã€‚</li>
</ul>

<p><strong>æ³¨æ„ï¼š</strong>æ¯ä¸ªå‡½æ•°éƒ½åº”å½“æ»¡è¶³ <code>O(1)</code> å¹³å‡æ—¶é—´å¤æ‚åº¦ã€‚</p>

<p>&nbsp;</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre>
<strong>è¾“å…¥</strong>
["AllOne", "inc", "inc", "getMaxKey", "getMinKey", "inc", "getMaxKey", "getMinKey"]
[[], ["hello"], ["hello"], [], [], ["leet"], [], []]
<strong>è¾“å‡º</strong>
[null, null, null, "hello", "hello", null, "hello", "leet"]

<strong>è§£é‡Š</strong>
AllOne allOne = new AllOne();
allOne.inc("hello");
allOne.inc("hello");
allOne.getMaxKey(); // è¿”å› "hello"
allOne.getMinKey(); // è¿”å› "hello"
allOne.inc("leet");
allOne.getMaxKey(); // è¿”å› "hello"
allOne.getMinKey(); // è¿”å› "leet"
</pre>

<p>&nbsp;</p>

<p><strong>æç¤ºï¼š</strong></p>

<ul>
	<li><code>1 &lt;= key.length &lt;= 10</code></li>
	<li><code>key</code> ç”±å°å†™è‹±æ–‡å­—æ¯ç»„æˆ</li>
	<li>æµ‹è¯•ç”¨ä¾‹ä¿è¯ï¼šåœ¨æ¯æ¬¡è°ƒç”¨ <code>dec</code> æ—¶ï¼Œæ•°æ®ç»“æ„ä¸­æ€»å­˜åœ¨ <code>key</code></li>
	<li>æœ€å¤šè°ƒç”¨ <code>inc</code>ã€<code>dec</code>ã€<code>getMaxKey</code> å’Œ <code>getMinKey</code> æ–¹æ³• <code>5 * 10<sup>4</sup></code> æ¬¡</li>
</ul>


## è§£é¢˜æ€è·¯

è¿™é“é¢˜å¯ä»¥ç”¨ **å“ˆå¸Œè¡¨ + åŒå‘é“¾è¡¨** æ¥è§£å†³ã€‚

- é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸€ä¸ªå­—ç¬¦ä¸²é›†åˆ `keys`ï¼Œå’Œä¸€ä¸ªæ­£æ•´æ•° `count`ï¼Œè¡¨ç¤º `keys` ä¸­çš„å­—ç¬¦ä¸²å‡å‡ºç° `count` æ¬¡ã€‚æ³¨æ„ï¼Œ `count` ç›¸åŒçš„å­—ç¬¦ä¸²å­˜å‚¨åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸­ã€‚
- é“¾è¡¨ä»å¤´åˆ°å°¾çš„æ¯ä¸ªèŠ‚ç‚¹çš„ `count` å€¼å•è°ƒé€’å¢ï¼ˆä½†ä¸ä¸€å®šè¿ç»­ï¼‰ã€‚
- æ¯ä¸ªèŠ‚ç‚¹è¿˜éœ€å­˜å‚¨æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ `prev` å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ `next`ã€‚
- å¦å¤–è¿˜è¦ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨ `map` ç»´æŠ¤æ¯ä¸ªå­—ç¬¦ä¸²å½“å‰æ‰€å¤„çš„é“¾è¡¨èŠ‚ç‚¹ã€‚

1. å¯¹äº `inc` æ“ä½œï¼š

- å½“è‹¥ `key` ä¸åœ¨é“¾è¡¨ä¸­ï¼Œåˆ¤æ–­å½“å‰é“¾è¡¨æœ‰æ²¡æœ‰ `count = 1` çš„èŠ‚ç‚¹ã€‚å› ä¸ºé“¾è¡¨æ˜¯æŒ‰ç…§ `count` å‡åºæ’åˆ—çš„ï¼Œæ‰€ä»¥åªéœ€è¦çœ‹å¤´èŠ‚ç‚¹çš„ `count` æ˜¯å¦ä¸º `1`ï¼›

  - è‹¥æœ‰åˆ™å…±ç”¨æ­¤èŠ‚ç‚¹ï¼›
  - å¦åˆ™æ–°å»ºä¸€ä¸ª `count = 1` çš„èŠ‚ç‚¹ï¼›

- è‹¥ `key` åœ¨é“¾è¡¨ä¸­ï¼Œè®¾ `key` æ‰€åœ¨èŠ‚ç‚¹ä¸º `cur`ï¼Œåˆ¤æ–­å½“å‰é“¾è¡¨æœ‰æ²¡æœ‰ `count = cur.count + 1` çš„èŠ‚ç‚¹ã€‚åŒç†ä¹Ÿåªéœ€è¦åˆ¤æ–­ `cur.next` çš„ `count` æ˜¯å¦ç­‰äº `cur.count + 1`ï¼›

  - è‹¥æœ‰åˆ™å…±ç”¨æ­¤ `cur.next` èŠ‚ç‚¹ï¼›
  - å¦åˆ™æ–°å»ºä¸€ä¸ª `count = cur.count + 1` çš„èŠ‚ç‚¹æ’å…¥åˆ° cur çš„åé¢ï¼›
  - æœ€åï¼Œå°† `key` ä» `cur.keys` ä¸­ç§»é™¤ï¼Œè‹¥ç§»é™¤å cur.keys ä¸ºç©ºï¼Œåˆ™å°† cur ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚å¹¶æ›´æ–° `map` ä¸­ `key` æ‰€å¤„çš„èŠ‚ç‚¹ã€‚

2. å¯¹äº `dec` æ“ä½œï¼š

- è‹¥ `key` ä»…å‡ºç°ä¸€æ¬¡ï¼šå°†å…¶ä» `map` ä¸­ç§»é™¤ã€‚
- è‹¥ `key` å‡ºç°ä¸æ­¢ä¸€æ¬¡ï¼Œåˆ™éœ€è¦åˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦æœ‰ `count = cur.count - 1` çš„èŠ‚ç‚¹.
  - è‹¥æœ‰ï¼Œåˆ™å…±ç”¨æ­¤ `cur.prev` èŠ‚ç‚¹;
  - å¦åˆ™æ–°å»ºä¸€ä¸ª `count = cur.count - 1` çš„èŠ‚ç‚¹ï¼›
- æœ€åï¼Œå°† `key` ä» `cur.keys` ä¸­ç§»é™¤ï¼Œè‹¥ç§»é™¤å `cur.keys` ä¸ºç©ºï¼Œåˆ™å°† `cur` ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚

3. å¯¹äº `getMaxKey` æ“ä½œ:

- åœ¨é“¾è¡¨ä¸ä¸ºç©ºæ—¶ï¼Œè¿”å›é“¾è¡¨å°¾èŠ‚ç‚¹çš„ `keys` ä¸­çš„ä»»ä¸€å…ƒç´ ;
- å¦åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚

4. å¯¹äº `getMinKey` æ“ä½œ

- åœ¨é“¾è¡¨ä¸ä¸ºç©ºæ—¶ï¼Œè¿”å›é“¾è¡¨å¤´èŠ‚ç‚¹çš„ `keys` ä¸­çš„ä»»ä¸€å…ƒç´ ;
- å¦åˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚

#### å¤æ‚åº¦åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**ï¼šæ‰€æœ‰æ“ä½œå‡ä¸º `O(1)`ï¼Œè¿™é‡Œå°†å­—ç¬¦ä¸²é•¿åº¦è§†ä½œå¸¸æ•°ã€‚
- **ç©ºé—´å¤æ‚åº¦**ï¼š`O(n)`ï¼Œå…¶ä¸­ `n` æ˜¯è°ƒç”¨ `inc` çš„æ¬¡æ•°ã€‚æœ€åæƒ…å†µä¸‹æ¯æ¬¡è°ƒç”¨ `inc` ä¼ å…¥çš„å­—ç¬¦ä¸²å‡ä¸ç›¸åŒï¼Œæˆ‘ä»¬éœ€è¦ `O(n)` å¤§å°çš„å“ˆå¸Œè¡¨æ¥å­˜å‚¨æ‰€æœ‰å­—ç¬¦ä¸²ã€‚

## ä»£ç 

```javascript
class Node {
	constructor(key, count) {
		this.keys = new Set([key || '']);
		this.count = count || 0;
	}

	insert(node) {
		node.prev = this;
		node.next = this.next;
		node.prev.next = node;
		node.next.prev = node;

		return node;
	}
	remove() {
		this.next.prev = this.prev;
		this.prev.next = this.next;
	}
}
var AllOne = function () {
	this.map = new Map();
	this.root = new Node('', 0);
	this.root.next = this.root;
	this.root.prev = this.root;
};

/**
 * @param {string} key
 * @return {void}
 */
AllOne.prototype.inc = function (key) {
	// key åœ¨é“¾è¡¨ä¸­
	if (this.map.has(key)) {
		let cur = this.map.get(key),
			next = cur.next;

		if (next == this.root || next.count > cur.count + 1) {
			this.map.set(key, cur.insert(new Node(key, cur.count + 1)));
		} else {
			next.keys.add(key);
			this.map.set(key, next);
		}
		cur.keys.delete(key);
		if (cur.keys.size == 0) {
			cur.remove();
		}
	}
	// key ä¸åœ¨é“¾è¡¨ä¸­
	else {
		if (this.root.next === this.root || this.root.next.count > 1) {
			this.map.set(key, this.root.insert(new Node(key, 1)));
		} else {
			this.root.next.keys.add(key);
			this.map.set(key, this.root.next);
		}
	}
};

/**
 * @param {string} key
 * @return {void}
 */
AllOne.prototype.dec = function (key) {
	const cur = this.map.get(key);
	// count ä¸º 1 æ—¶ï¼Œç›´æ¥åˆ æ‰
	if (cur.count == 1) {
		this.map.delete(key);
	}
	// count å¤§äº 1 æ—¶ï¼Œå¯»æ‰¾ dec å key åœ¨é“¾è¡¨ä¸­çš„ä½ç½®
	else {
		const prev = cur.prev;
		if (prev == this.root || prev.count < cur.count - 1) {
			this.map.set(key, prev.insert(new Node(key, cur.count - 1)));
		} else {
			prev.keys.add(key);
			this.map.set(key, prev);
		}
	}
	cur.keys.delete(key);
	if (cur.keys.size == 0) {
		cur.remove();
	}
};

/**
 * @return {string}
 */
AllOne.prototype.getMaxKey = function () {
	if (!this.root.prev) return '';
	let maxKey = '';
	for (let key of this.root.prev.keys) {
		maxKey = key;
		break;
	}
	return maxKey;
};

/**
 * @return {string}
 */
AllOne.prototype.getMinKey = function () {
	if (!this.root.next) return '';
	let minKey = '';
	for (let key of this.root.next.keys) {
		minKey = key;
		break;
	}
	return minKey;
};

/**
 * Your AllOne object will be instantiated and called as such:
 * var obj = new AllOne()
 * obj.inc(key)
 * obj.dec(key)
 * var param_3 = obj.getMaxKey()
 * var param_4 = obj.getMinKey()
 */
```
