---
title: 123. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº III
description: LeetCode 123. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº IIIé¢˜è§£ï¼ŒBest Time to Buy and Sell Stock IIIï¼ŒåŒ…å«è§£é¢˜æ€è·¯ã€å¤æ‚åº¦åˆ†æä»¥åŠå®Œæ•´çš„ JavaScript ä»£ç å®ç°ã€‚
keywords:
  - LeetCode
  - 123. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº III
  - ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº III
  - Best Time to Buy and Sell Stock III
  - è§£é¢˜æ€è·¯
  - æ•°ç»„
  - åŠ¨æ€è§„åˆ’
---

# 123. ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº III

ğŸ”´ <font color=#ff334b>Hard</font>&emsp; ğŸ”–&ensp; [`æ•°ç»„`](/tag/array.md) [`åŠ¨æ€è§„åˆ’`](/tag/dynamic-programming.md)&emsp; ğŸ”—&ensp;[`åŠ›æ‰£`](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-iii) [`LeetCode`](https://leetcode.com/problems/best-time-to-buy-and-sell-stock-iii)

## é¢˜ç›®

You are given an array `prices` where `prices[i]` is the price of a given
stock on the `ith` day.

Find the maximum profit you can achieve. You may complete **at most two
transactions**.

**Note:** You may not engage in multiple transactions simultaneously (i.e.,
you must sell the stock before you buy again).

**Example 1:**

> Input: prices = [3,3,5,0,0,3,1,4]
>
> Output: 6
>
> Explanation: Buy on day 4 (price = 0) and sell on day 6 (price = 3), profit = 3-0 = 3.
>
> Then buy on day 7 (price = 1) and sell on day 8 (price = 4), profit = 4-1 = 3.

**Example 2:**

> Input: prices = [1,2,3,4,5]
>
> Output: 4
>
> Explanation: Buy on day 1 (price = 1) and sell on day 5 (price = 5), profit = 5-1 = 4.
>
> Note that you cannot buy on day 1, buy on day 2 and sell them later, as you are engaging multiple transactions at the same time. You must sell before buying again.

**Example 3:**

> Input: prices = [7,6,4,3,1]
>
> Output: 0
>
> Explanation: In this case, no transaction is done, i.e. max profit = 0.

**Constraints:**

- `1 <= prices.length <= 10^5`
- `0 <= prices[i] <= 10^5`

## é¢˜ç›®å¤§æ„

ç»™å®šä¸€ä¸ªæ•°ç»„ï¼Œå®ƒçš„ç¬¬ `i` ä¸ªå…ƒç´ æ˜¯ä¸€æ”¯ç»™å®šçš„è‚¡ç¥¨åœ¨ç¬¬ `i` å¤©çš„ä»·æ ¼ã€‚

è®¾è®¡ä¸€ä¸ªç®—æ³•æ¥è®¡ç®—ä½ æ‰€èƒ½è·å–çš„æœ€å¤§åˆ©æ¶¦ã€‚ä½ æœ€å¤šå¯ä»¥å®Œæˆ **ä¸¤ç¬”** äº¤æ˜“ã€‚

**æ³¨æ„**ï¼šä½ ä¸èƒ½åŒæ—¶å‚ä¸å¤šç¬”äº¤æ˜“ï¼ˆä½ å¿…é¡»åœ¨å†æ¬¡è´­ä¹°å‰å‡ºå”®æ‰ä¹‹å‰çš„è‚¡ç¥¨ï¼‰ã€‚

**ç¤ºä¾‹ 1:**

> è¾“å…¥ï¼šprices = [3,3,5,0,0,3,1,4]
>
> è¾“å‡ºï¼š6
>
> è§£é‡Šï¼šåœ¨ç¬¬ 4 å¤©ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 0ï¼‰çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 6 å¤©ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 3ï¼‰çš„æ—¶å€™å–å‡ºï¼Œè¿™ç¬”äº¤æ˜“æ‰€èƒ½è·å¾—åˆ©æ¶¦ = 3-0 = 3 ã€‚
>
> éšåï¼Œåœ¨ç¬¬ 7 å¤©ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 1ï¼‰çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 8 å¤© ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 4ï¼‰çš„æ—¶å€™å–å‡ºï¼Œè¿™ç¬”äº¤æ˜“æ‰€èƒ½è·å¾—åˆ©æ¶¦ = 4-1 = 3 ã€‚

**ç¤ºä¾‹ 2ï¼š**

> è¾“å…¥ï¼šprices = [1,2,3,4,5]
>
> è¾“å‡ºï¼š4
>
> è§£é‡Šï¼šåœ¨ç¬¬ 1 å¤©ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 1ï¼‰çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 5 å¤© ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 5ï¼‰çš„æ—¶å€™å–å‡º, è¿™ç¬”äº¤æ˜“æ‰€èƒ½è·å¾—åˆ©æ¶¦ = 5-1 = 4 ã€‚
>
> æ³¨æ„ä½ ä¸èƒ½åœ¨ç¬¬ 1 å¤©å’Œç¬¬ 2 å¤©æ¥è¿è´­ä¹°è‚¡ç¥¨ï¼Œä¹‹åå†å°†å®ƒä»¬å–å‡ºã€‚
>
> å› ä¸ºè¿™æ ·å±äºåŒæ—¶å‚ä¸äº†å¤šç¬”äº¤æ˜“ï¼Œä½ å¿…é¡»åœ¨å†æ¬¡è´­ä¹°å‰å‡ºå”®æ‰ä¹‹å‰çš„è‚¡ç¥¨ã€‚

**ç¤ºä¾‹ 3ï¼š**

> è¾“å…¥ï¼šprices = [7,6,4,3,1]
>
> è¾“å‡ºï¼š0
>
> è§£é‡Šï¼šåœ¨è¿™ä¸ªæƒ…å†µä¸‹, æ²¡æœ‰äº¤æ˜“å®Œæˆ, æ‰€ä»¥æœ€å¤§åˆ©æ¶¦ä¸º 0ã€‚

**ç¤ºä¾‹ 4ï¼š**

> è¾“å…¥ï¼šprices = [1]
>
> è¾“å‡ºï¼š0

## è§£é¢˜æ€è·¯

### æ€è·¯ä¸€ï¼šåŠ¨æ€è§„åˆ’

1. **åŠ¨æ€è§„åˆ’ï¼š** å®šä¹‰ä¸€ä¸ªä¸‰ç»´æ•°ç»„ `dp`ï¼Œå…¶ä¸­ `dp[i][j][0]` è¡¨ç¤ºæˆªè‡³ç¬¬ `i` å¤©ã€æœ€å¤šè¿›è¡Œ `j` æ¬¡äº¤æ˜“ã€ä¸æŒæœ‰è‚¡ç¥¨æ—¶çš„æœ€å¤§åˆ©æ¶¦ï¼Œ `dp[i][j][1]` è¡¨ç¤ºç¤ºæˆªè‡³ç¬¬ `i` å¤©ã€æœ€å¤šè¿›è¡Œ `j` æ¬¡äº¤æ˜“ã€æŒæœ‰è‚¡ç¥¨æ—¶çš„æœ€å¤§åˆ©æ¶¦ã€‚

::: info
çŠ¶æ€ `j` çš„å®šä¹‰å¹¶ä¸æ˜¯ã€Œ**å·²è¿›è¡Œçš„äº¤æ˜“æ¬¡æ•°**ã€ï¼Œè€Œæ˜¯ã€Œ**æœ€å¤§äº¤æ˜“æ¬¡æ•°çš„ä¸Šé™é™åˆ¶**ã€ã€‚å¦‚æœç¡®å®šä»Šå¤©è¿›è¡Œä¸€æ¬¡äº¤æ˜“ï¼Œä¸”è¦ä¿è¯æˆªè‡³ä»Šå¤©æœ€å¤§äº¤æ˜“æ¬¡æ•°ä¸Šé™ä¸º `j`ï¼Œé‚£ä¹ˆæ˜¨å¤©çš„æœ€å¤§äº¤æ˜“æ¬¡æ•°ä¸Šé™å¿…é¡»æ˜¯ `j - 1`ã€‚
:::

2. **çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š**

   - `dp[i][j][0] = max(dp[i-1][j][0], dp[i-1][j][1] + prices[i])`ï¼Œè¡¨ç¤ºåœ¨ç¬¬ `i` å¤©ï¼Œä¸æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦ç­‰äºå‰ä¸€å¤©ä¸æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦ï¼Œæˆ–è€…å‰ä¸€å¤©æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦åŠ ä¸Šä»Šå¤©å–å‡ºçš„åˆ©æ¶¦çš„æœ€å¤§å€¼ã€‚
   - `dp[i][j][1] = max(dp[i-1][j][1], dp[i-1][j-1][0] - prices[i])`ï¼Œè¡¨ç¤ºåœ¨ç¬¬ `i` å¤©ï¼ŒæŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦ç­‰äºå‰ä¸€å¤©æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦ï¼Œæˆ–è€…å‰ä¸€å¤©ä¸æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦å‡å»ä»Šå¤©ä¹°å…¥çš„åˆ©æ¶¦çš„æœ€å¤§å€¼ï¼Œä»Šå¤©ä¹°å…¥çš„è¯ï¼Œå‰ä¸€å¤©çš„äº¤æ˜“æ¬¡æ•°ä¸Šé™è¦å‡ä¸€ã€‚

   - ç”±äº `j` çš„å–å€¼èŒƒå›´è¾ƒå°ï¼Œå¯ä»¥ç›´æ¥æŠŠ `j = 1ã€2` çš„æƒ…å†µå…¨éƒ¨åˆ—ä¸¾å‡ºæ¥ä¹Ÿå¯ä»¥ï¼š

     - `dp[i][2][0] = max(dp[i-1][2][0], dp[i-1][2][1] + prices[i])`
     - `dp[i][2][1] = max(dp[i-1][2][1], dp[i-1][1][0] - prices[i])`
     - `dp[i][1][0] = max(dp[i-1][1][0], dp[i-1][1][1] + prices[i])`
     - `dp[i][1][1] = max(dp[i-1][1][1], -prices[i])`

3. **è¾¹ç•Œæ¡ä»¶ï¼š** ç¬¬ä¸€å¤©ï¼ˆ`i == 0`ï¼‰æ—¶ï¼Œ`dp[0][j][0] = 0`ï¼Œ`dp[0][j][1] = -prices[0]`ã€‚
4. **åˆå§‹åŒ–ï¼š** åˆå§‹åŒ–åˆ©æ¶¦ä¸º 0ã€‚
5. **è¿”å›æœ€å¤§åˆ©æ¶¦ï¼š** æœ€åè¿”å› `dp[n - 1][2][0]`ï¼Œå³æœ€åä¸€å¤©ä¸æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦ï¼Œå› ä¸ºè‹¥æœ€åä¸€å¤©è¿˜æŒæœ‰è‚¡ç¥¨æ²¡æœ‰å–å‡ºï¼Œæ”¶ç›Šè‚¯å®šå°äºåšäº†ä¸€æ¬¡äº¤æ˜“çš„æƒ…å†µã€‚

- **æ—¶é—´å¤æ‚åº¦**: `O(n)` - éå†æ•´ä¸ªäºŒç»´æ•°ç»„ï¼Œå…¶ä¸­ n æ˜¯è‚¡ç¥¨ä»·æ ¼æ•°ç»„çš„é•¿åº¦ã€‚
- **ç©ºé—´å¤æ‚åº¦**: `O(n)` - ä½¿ç”¨äº†ä¸€ä¸ª `2 * 3 * n` çš„ä¸‰ç»´æ•°ç»„æ¥å­˜å‚¨ä¸­é—´çŠ¶æ€ã€‚

---

### æ€è·¯äºŒï¼šåŠ¨æ€è§„åˆ’-çŠ¶æ€å‹ç¼©

1. **çŠ¶æ€å®šä¹‰**ï¼šç”±äº `dp[i][...]` åªä¸å’Œ `dp[i - 1][...]` æœ‰å…³ï¼Œä¸” `j` åªæœ‰ä¸¤ç§æƒ…å†µï¼Œæ‰€ä»¥å¯å°† `dp` æ•°ç»„ç®€åŒ–ä¸ºå››ä¸ªçŠ¶æ€ï¼š

   - `dp_i20`ï¼šæˆªè‡³ç¬¬ i å¤©ã€æœ€å¤šäº¤æ˜“ä¸¤æ¬¡ã€ä¸æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§æ”¶ç›Š;
   - `dp_i21`ï¼šæˆªè‡³ç¬¬ i å¤©ã€æœ€å¤šäº¤æ˜“ä¸¤æ¬¡ã€æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§æ”¶ç›Š;
   - `dp_i10`ï¼šæˆªè‡³ç¬¬ i å¤©ã€æœ€å¤šäº¤æ˜“ä¸€æ¬¡ã€ä¸æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§æ”¶ç›Š;
   - `dp_i11`ï¼šæˆªè‡³ç¬¬ i å¤©ã€æœ€å¤šäº¤æ˜“ä¸€æ¬¡ã€æŒæœ‰è‚¡ç¥¨çš„æœ€å¤§æ”¶ç›Š;

2. **çŠ¶æ€è½¬ç§»æ–¹ç¨‹**ï¼š

   - `dp_i20 = max(dp_i20, dp_i21 + prices[i])`
   - `dp_i21 = max(dp_i21, dp_i10 - prices[i])`
   - `dp_i10 = max(dp_i10, dp_i11 + prices[i])`
   - `dp_i11 = max(dp_i11, -prices[i])`

3. **éå†å¤©æ•°**ï¼šéå†æ¯ä¸€å¤©çš„è‚¡ç¥¨ä»·æ ¼ï¼Œæ›´æ–°å››ä¸ªçŠ¶æ€çš„å€¼ã€‚

4. **è¿”å›ç»“æœ**ï¼šè¿”å›æœ€ç»ˆçš„ `dp_i20` å€¼ï¼Œå³æœ€å¤§çš„åˆ©æ¶¦ã€‚

#### å¤æ‚åº¦åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**: `O(n)`ï¼Œåªéœ€è¦éå†ä¸€æ¬¡è‚¡ç¥¨ä»·æ ¼æ•°ç»„ã€‚
- **ç©ºé—´å¤æ‚åº¦**: `O(1)`ï¼Œåªä½¿ç”¨äº†å¸¸æ•°ä¸ªé¢å¤–çš„å˜é‡ã€‚

## ä»£ç 

::: code-tabs
@tab åŠ¨æ€è§„åˆ’

```javascript
/**
 * @param {number[]} prices
 * @return {number}
 */
var maxProfit = function (prices) {
	const n = prices.length;
	const m = 2;
	const dp = new Array(n)
		.fill(0)
		.map(() => new Array(m + 1).fill(0).map(() => new Array(2).fill(0)));
	for (let i in prices) {
		for (let j = m; j >= 1; j--) {
			if (i == 0) {
				dp[0][j][0] = 0;
				dp[0][j][1] = -prices[0];
				continue;
			}
			dp[i][j][0] = Math.max(dp[i - 1][j][0], dp[i - 1][j][1] + prices[i]);
			dp[i][j][1] = Math.max(dp[i - 1][j][1], dp[i - 1][j - 1][0] - prices[i]);
		}
	}
	return dp[n - 1][m][0];
};
```

@tab åŠ¨æ€è§„åˆ’-çŠ¶æ€å‹ç¼©

```javascript
/**
 * @param {number[]} prices
 * @return {number}
 */
var maxProfit = function (prices) {
	let dp_i20 = 0,
		dp_i21 = -Infinity,
		dp_i10 = 0,
		dp_i11 = -Infinity;
	for (let price of prices) {
		dp_i20 = Math.max(dp_i20, dp_i21 + price);
		dp_i21 = Math.max(dp_i21, dp_i10 - price);
		dp_i10 = Math.max(dp_i10, dp_i11 + price);
		dp_i11 = Math.max(dp_i11, -price);
	}
	return dp_i20;
};
```

:::

## ç›¸å…³é¢˜ç›®

<!-- prettier-ignore -->
| é¢˜å· | æ ‡é¢˜ | é¢˜è§£ | æ ‡ç­¾ | éš¾åº¦ | åŠ›æ‰£ |
| :------: | :------ | :------: | :------ | :------: | :------: |
| 121 | ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº | [[âœ“]](/problem/0121.md) |  [`æ•°ç»„`](/tag/array.md) [`åŠ¨æ€è§„åˆ’`](/tag/dynamic-programming.md) | ğŸŸ¢ | [ğŸ€„ï¸](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock) [ğŸ”—](https://leetcode.com/problems/best-time-to-buy-and-sell-stock) |
| 122 | ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº II | [[âœ“]](/problem/0122.md) |  [`è´ªå¿ƒ`](/tag/greedy.md) [`æ•°ç»„`](/tag/array.md) [`åŠ¨æ€è§„åˆ’`](/tag/dynamic-programming.md) | ğŸŸ  | [ğŸ€„ï¸](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-ii) [ğŸ”—](https://leetcode.com/problems/best-time-to-buy-and-sell-stock-ii) |
| 188 | ä¹°å–è‚¡ç¥¨çš„æœ€ä½³æ—¶æœº IV | [[âœ“]](/problem/0188.md) |  [`æ•°ç»„`](/tag/array.md) [`åŠ¨æ€è§„åˆ’`](/tag/dynamic-programming.md) | ğŸ”´ | [ğŸ€„ï¸](https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-iv) [ğŸ”—](https://leetcode.com/problems/best-time-to-buy-and-sell-stock-iv) |
| 689 | ä¸‰ä¸ªæ— é‡å å­æ•°ç»„çš„æœ€å¤§å’Œ | [[âœ“]](/problem/0689.md) |  [`æ•°ç»„`](/tag/array.md) [`åŠ¨æ€è§„åˆ’`](/tag/dynamic-programming.md) | ğŸ”´ | [ğŸ€„ï¸](https://leetcode.cn/problems/maximum-sum-of-3-non-overlapping-subarrays) [ğŸ”—](https://leetcode.com/problems/maximum-sum-of-3-non-overlapping-subarrays) |
| 2291 | æœ€å¤§è‚¡ç¥¨æ”¶ç›Š ğŸ”’ |  |  [`æ•°ç»„`](/tag/array.md) [`åŠ¨æ€è§„åˆ’`](/tag/dynamic-programming.md) | ğŸŸ  | [ğŸ€„ï¸](https://leetcode.cn/problems/maximum-profit-from-trading-stocks) [ğŸ”—](https://leetcode.com/problems/maximum-profit-from-trading-stocks) |
| 2555 | ä¸¤ä¸ªçº¿æ®µè·å¾—çš„æœ€å¤šå¥–å“ |  |  [`æ•°ç»„`](/tag/array.md) [`äºŒåˆ†æŸ¥æ‰¾`](/tag/binary-search.md) [`æ»‘åŠ¨çª—å£`](/tag/sliding-window.md) | ğŸŸ  | [ğŸ€„ï¸](https://leetcode.cn/problems/maximize-win-from-two-segments) [ğŸ”—](https://leetcode.com/problems/maximize-win-from-two-segments) |