---
title: 381. O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´  - å…è®¸é‡å¤
description: LeetCode 381. O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´  - å…è®¸é‡å¤é¢˜è§£ï¼ŒInsert Delete GetRandom O(1) - Duplicates allowedï¼ŒåŒ…å«è§£é¢˜æ€è·¯ã€å¤æ‚åº¦åˆ†æä»¥åŠå®Œæ•´çš„ JavaScript ä»£ç å®ç°ã€‚
keywords:
  - LeetCode
  - 381. O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´  - å…è®¸é‡å¤
  - O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´  - å…è®¸é‡å¤
  - Insert Delete GetRandom O(1) - Duplicates allowed
  - è§£é¢˜æ€è·¯
  - è®¾è®¡
  - æ•°ç»„
  - å“ˆå¸Œè¡¨
  - æ•°å­¦
  - éšæœºåŒ–
---

# 381. O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´  - å…è®¸é‡å¤

ğŸ”´ <font color=#ff334b>Hard</font>&emsp; ğŸ”–&ensp; [`è®¾è®¡`](/tag/design.md) [`æ•°ç»„`](/tag/array.md) [`å“ˆå¸Œè¡¨`](/tag/hash-table.md) [`æ•°å­¦`](/tag/math.md) [`éšæœºåŒ–`](/tag/randomized.md)&emsp; ğŸ”—&ensp;[`åŠ›æ‰£`](https://leetcode.cn/problems/insert-delete-getrandom-o1-duplicates-allowed) [`LeetCode`](https://leetcode.com/problems/insert-delete-getrandom-o1-duplicates-allowed)

## é¢˜ç›®

`RandomizedCollection` is a data structure that contains a collection of
numbers, possibly duplicates (i.e., a multiset). It should support inserting
and removing specific elements and also reporting a random element.

Implement the `RandomizedCollection` class:

- `RandomizedCollection()` Initializes the empty `RandomizedCollection` object.
- `bool insert(int val)` Inserts an item `val` into the multiset, even if the item is already present. Returns `true` if the item is not present, `false` otherwise.
- `bool remove(int val)` Removes an item `val` from the multiset if present. Returns `true` if the item is present, `false` otherwise. Note that if `val` has multiple occurrences in the multiset, we only remove one of them.
- `int getRandom()` Returns a random element from the current multiset of elements. The probability of each element being returned is **linearly related** to the number of the same values the multiset contains.

You must implement the functions of the class such that each function works on
**average** `O(1)` time complexity.

**Note:** The test cases are generated such that `getRandom` will only be
called if there is **at least one** item in the `RandomizedCollection`.

**Example 1:**

> **Input**
>
> ["RandomizedCollection", "insert", "insert", "insert", "getRandom", "remove", "getRandom"]
>
> [[], [1], [1], [2], [], [1], []]
>
> **Output**
>
> [null, true, false, true, 2, true, 1]
>
> **Explanation**
>
> RandomizedCollection randomizedCollection = new RandomizedCollection();
>
> randomizedCollection.insert(1); // return true since the collection does not contain 1.
>
> // Inserts 1 into the collection.
>
> randomizedCollection.insert(1); // return false since the collection contains 1.
>
> // Inserts another 1 into the collection. Collection now contains [1,1].
>
> randomizedCollection.insert(2); // return true since the collection does not contain 2.
>
> // Inserts 2 into the collection. Collection now contains [1,1,2].
>
> randomizedCollection.getRandom(); // getRandom should:
>
> // - return 1 with probability 2/3, or
>
> // - return 2 with probability 1/3.
>
> randomizedCollection.remove(1); // return true since the collection contains 1.
>
> // Removes 1 from the collection. Collection now contains [1,2].
>
> randomizedCollection.getRandom(); // getRandom should return 1 or 2, both equally likely.

**Constraints:**

- `-2^31 <= val <= 2^31 - 1`
- At most `2 * 10^5` calls **in total** will be made to `insert`, `remove`, and `getRandom`.
- There will be **at least one** element in the data structure when `getRandom` is called.

## é¢˜ç›®å¤§æ„

`RandomizedCollection` æ˜¯ä¸€ç§åŒ…å«æ•°å­—é›†åˆ(å¯èƒ½æ˜¯é‡å¤çš„)çš„æ•°æ®ç»“æ„ã€‚å®ƒåº”è¯¥æ”¯æŒæ’å…¥å’Œåˆ é™¤ç‰¹å®šå…ƒç´ ï¼Œä»¥åŠåˆ é™¤éšæœºå…ƒç´ ã€‚

å®ç° `RandomizedCollection` ç±»:

- `RandomizedCollection()`åˆå§‹åŒ–ç©ºçš„ `RandomizedCollection` å¯¹è±¡ã€‚
- `bool insert(int val)` å°†ä¸€ä¸ª `val` é¡¹æ’å…¥åˆ°é›†åˆä¸­ï¼Œå³ä½¿è¯¥é¡¹å·²ç»å­˜åœ¨ã€‚å¦‚æœè¯¥é¡¹ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› `true` ï¼Œå¦åˆ™è¿”å› `false` ã€‚
- `bool remove(int val)` å¦‚æœå­˜åœ¨ï¼Œä»é›†åˆä¸­ç§»é™¤ä¸€ä¸ª `val` é¡¹ã€‚å¦‚æœè¯¥é¡¹å­˜åœ¨ï¼Œåˆ™è¿”å› `true` ï¼Œå¦åˆ™è¿”å› `false` ã€‚æ³¨æ„ï¼Œå¦‚æœ `val` åœ¨é›†åˆä¸­å‡ºç°å¤šæ¬¡ï¼Œæˆ‘ä»¬åªåˆ é™¤å…¶ä¸­ä¸€ä¸ªã€‚
- `int getRandom()` ä»å½“å‰çš„å¤šä¸ªå…ƒç´ é›†åˆä¸­è¿”å›ä¸€ä¸ªéšæœºå…ƒç´ ã€‚æ¯ä¸ªå…ƒç´ è¢«è¿”å›çš„æ¦‚ç‡ä¸é›†åˆä¸­åŒ…å«çš„ç›¸åŒå€¼çš„æ•°é‡ **çº¿æ€§ç›¸å…³** ã€‚

æ‚¨å¿…é¡»å®ç°ç±»çš„å‡½æ•°ï¼Œä½¿æ¯ä¸ªå‡½æ•°çš„ **å¹³å‡** æ—¶é—´å¤æ‚åº¦ä¸º `O(1)` ã€‚

**æ³¨æ„ï¼š** ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œåªæœ‰åœ¨ `RandomizedCollection` ä¸­ **è‡³å°‘æœ‰ä¸€é¡¹** æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ `getRandom` ã€‚

**ç¤ºä¾‹ 1:**

> **è¾“å…¥**
>
> ["RandomizedCollection", "insert", "insert", "insert", "getRandom", "remove", "getRandom"]
>
> [[], [1], [1], [2], [], [1], []]
>
> **è¾“å‡º**
>
> [null, true, false, true, 2, true, 1]
>
> **è§£é‡Š**
>
> RandomizedCollection collection = new RandomizedCollection();// åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„é›†åˆã€‚
>
> collection.insert(1); // è¿”å› trueï¼Œå› ä¸ºé›†åˆä¸åŒ…å« 1ã€‚
>
> // å°† 1 æ’å…¥åˆ°é›†åˆä¸­ã€‚
>
> collection.insert(1); // è¿”å› falseï¼Œå› ä¸ºé›†åˆåŒ…å« 1ã€‚
>
> // å°†å¦ä¸€ä¸ª 1 æ’å…¥åˆ°é›†åˆä¸­ã€‚é›†åˆç°åœ¨åŒ…å« [1,1]ã€‚
>
> collection.insert(2); // è¿”å› trueï¼Œå› ä¸ºé›†åˆä¸åŒ…å« 2ã€‚
>
> // å°† 2 æ’å…¥åˆ°é›†åˆä¸­ã€‚é›†åˆç°åœ¨åŒ…å« [1,1,2]ã€‚
>
> collection.getRandom(); // getRandom åº”å½“:
>
> // æœ‰ 2/3 çš„æ¦‚ç‡è¿”å› 1,
>
> // 1/3 çš„æ¦‚ç‡è¿”å› 2ã€‚
>
> collection.remove(1); // è¿”å› trueï¼Œå› ä¸ºé›†åˆåŒ…å« 1ã€‚
>
> // ä»é›†åˆä¸­ç§»é™¤ 1ã€‚é›†åˆç°åœ¨åŒ…å« [1,2]ã€‚
>
> collection.getRandom(); // getRandom åº”è¯¥è¿”å› 1 æˆ– 2ï¼Œä¸¤è€…çš„å¯èƒ½æ€§ç›¸åŒã€‚

**æç¤º:**

- `-2^31 <= val <= 2^31 - 1`
- `insert`, `remove` å’Œ `getRandom` æœ€å¤š **æ€»å…±** è¢«è°ƒç”¨ `2 * 10^5` æ¬¡
- å½“è°ƒç”¨ `getRandom` æ—¶ï¼Œæ•°æ®ç»“æ„ä¸­ **è‡³å°‘æœ‰ä¸€ä¸ª** å…ƒç´ 

## è§£é¢˜æ€è·¯

æˆ‘ä»¬éœ€è¦æ”¯æŒ **O(1) çš„æ’å…¥ã€åˆ é™¤å’Œéšæœºè®¿é—®**ï¼Œå› æ­¤é‡‡ç”¨ï¼š

- **æ•°ç»„ `elements`**ï¼šç”¨äºå­˜å‚¨æ‰€æœ‰æ’å…¥çš„å…ƒç´ ï¼Œæ–¹ä¾¿ `getRandom()` é€šè¿‡ç´¢å¼• **O(1)** è·å–éšæœºå…ƒç´ ã€‚
- **å“ˆå¸Œè¡¨ `indicesMap`**ï¼ˆ`Map<number, Set<number>>`ï¼‰ï¼š
  - **key**: å­˜å‚¨å…ƒç´ å€¼
  - **value**: è¯¥å€¼åœ¨æ•°ç»„ `elements` ä¸­çš„æ‰€æœ‰ç´¢å¼•é›†åˆï¼ˆ`Set`ï¼‰ã€‚
  - **ä¸ºä»€ä¹ˆç”¨ `Set`?** å…è®¸ç›¸åŒçš„ `val` å¤šæ¬¡æ’å…¥ï¼Œå¹¶ä¸”åˆ é™¤æ“ä½œä»ç„¶ä¿æŒ O(1) å¤æ‚åº¦ã€‚

#### 1. `insert(val)`

1. å…ˆæ£€æŸ¥ `val` æ˜¯å¦å·²ç»å­˜åœ¨äº `indicesMap`ã€‚
2. å°† `val` æ·»åŠ åˆ° `elements` æ•°ç»„çš„ **æœ«å°¾**ã€‚
3. åœ¨ `indicesMap` é‡Œ **è®°å½•ç´¢å¼•**ï¼š
   - å¦‚æœ `val` ä¸å­˜åœ¨ï¼Œåˆ›å»º `Set` å­˜å‚¨ç´¢å¼•ã€‚
   - å¦‚æœ `val` å·²å­˜åœ¨ï¼Œç›´æ¥å°†æ–°ç´¢å¼•åŠ å…¥ `Set`ã€‚
4. **è¿”å›** `val` æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ’å…¥ï¼ˆ`true` æˆ– `false`ï¼‰ã€‚

- **æ—¶é—´å¤æ‚åº¦ï¼šO(1)**ï¼Œå› ä¸º `æ•°ç»„ push` å’Œ `Map æ“ä½œ` çš†ä¸º O(1)ã€‚

---

#### 2. `remove(val)`

1. å…ˆæ£€æŸ¥ `val` æ˜¯å¦å­˜åœ¨äº `indicesMap`ï¼Œå¦‚æœä¸å­˜åœ¨ç›´æ¥è¿”å› `false`ã€‚
2. æ‰¾åˆ° `val` åœ¨æ•°ç»„ä¸­çš„æŸä¸ªç´¢å¼• `removeIndex`ã€‚
3. è·å– `elements` **æœ€åä¸€ä¸ªå…ƒç´ ** `lastElement`ï¼Œå‡†å¤‡ **å°†å…¶ç§»åŠ¨åˆ° `removeIndex` ä½ç½®**ï¼ˆé¿å…æ•°ç»„ `splice` æ“ä½œï¼Œä¿è¯ O(1)ï¼‰ã€‚
4. **æ›¿æ¢ `val`**
   - `elements[removeIndex] = lastElement` ï¼ˆå°†æœ€åä¸€ä¸ªå…ƒç´ ç§»åŠ¨åˆ° `val` çš„ä½ç½®ï¼‰
   - `elements.pop()` åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ 
5. æ›´æ–° `indicesMap`
   - **åˆ é™¤ `removeIndex`**ï¼Œå¦‚æœ `val` æ²¡æœ‰ç´¢å¼•äº†ï¼Œä» `Map` ä¸­åˆ é™¤ã€‚
   - **æ›´æ–° `lastElement` çš„ç´¢å¼•**ï¼ˆå¦‚æœ `lastElement` ä¸æ˜¯ `val` æœ¬èº«ï¼‰ã€‚
6. è¿”å› `true`ï¼Œè¡¨ç¤ºæˆåŠŸåˆ é™¤ã€‚

- **æ—¶é—´å¤æ‚åº¦ï¼šO(1)**ï¼Œå› ä¸ºï¼š
  - è·å–ç´¢å¼•æ˜¯ O(1) (`Set.values().next().value`)
  - æ›¿æ¢ç´¢å¼•æ˜¯ O(1)
  - `elements.pop()` æ˜¯ O(1)
  - `Map` æ“ä½œæ˜¯ O(1)

#### 3. `getRandom()`

1. ç”Ÿæˆ `[0, elements.length - 1]` ä¹‹é—´çš„éšæœºç´¢å¼•ã€‚
2. è¿”å› `elements[randomIndex]`ã€‚

- **æ—¶é—´å¤æ‚åº¦ï¼šO(1)**ï¼Œå› ä¸ºæ•°ç»„éšæœºè®¿é—®æ˜¯ O(1)ã€‚

#### å¤æ‚åº¦åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**ï¼š`O(1)`ï¼Œ` insert`, `remove ` å’Œ `getRandom` éƒ½æ˜¯`O(1)`æ—¶é—´å¤æ‚åº¦ã€‚
- **ç©ºé—´å¤æ‚åº¦**ï¼š`O(n)`ï¼Œä½¿ç”¨äº†ä¸€ä¸ªæ•°ç»„å’Œä¸€ä¸ªå“ˆå¸Œè¡¨å­˜å‚¨å…ƒç´ åŠå…¶ç´¢å¼•ã€‚

## ä»£ç 

```javascript
class RandomizedCollection {
	constructor() {
		this.elements = []; // å­˜å‚¨æ‰€æœ‰æ’å…¥çš„å…ƒç´ 
		this.indicesMap = new Map(); // Map<number, Set<number>>ï¼Œå­˜å‚¨æ¯ä¸ªå€¼çš„ç´¢å¼•é›†åˆ
	}

	/**
	 * æ’å…¥ä¸€ä¸ªå€¼åˆ°é›†åˆä¸­
	 * @param {number} val
	 * @return {boolean} æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ’å…¥
	 */
	insert(val) {
		const exists = this.indicesMap.has(val); // è®°å½• val æ˜¯å¦å·²ç»å­˜åœ¨
		this.elements.push(val); // å°† val æ·»åŠ åˆ°æ•°ç»„æœ«å°¾

		// åœ¨å“ˆå¸Œè¡¨ä¸­è®°å½• val å¯¹åº”çš„ç´¢å¼•
		if (!exists) {
			this.indicesMap.set(val, new Set());
		}
		this.indicesMap.get(val).add(this.elements.length - 1);

		return !exists;
	}

	/**
	 * ä»é›†åˆä¸­åˆ é™¤ä¸€ä¸ªå€¼
	 * @param {number} val
	 * @return {boolean} æ˜¯å¦åˆ é™¤æˆåŠŸ
	 */
	remove(val) {
		if (!this.indicesMap.has(val)) return false; // è‹¥ val ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å› false

		const lastIndex = this.elements.length - 1; // è·å–æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•
		const valIndices = this.indicesMap.get(val); // è·å– val æ‰€åœ¨çš„ç´¢å¼•é›†åˆ
		const removeIndex = valIndices.values().next().value; // å–å‡º val åœ¨æ•°ç»„ä¸­çš„æŸä¸ªç´¢å¼•

		const lastElement = this.elements[lastIndex]; // è·å–æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ 
		this.elements[removeIndex] = lastElement; // ç”¨æœ€åä¸€ä¸ªå…ƒç´ è¦†ç›–å¾…åˆ é™¤å…ƒç´ 
		this.elements.pop(); // åˆ é™¤æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ 

		// æ›´æ–° val çš„ç´¢å¼•é›†åˆ
		valIndices.delete(removeIndex);
		if (valIndices.size === 0) this.indicesMap.delete(val); // è‹¥ val æ²¡æœ‰ç´¢å¼•äº†ï¼Œä» Map ä¸­åˆ é™¤

		// è‹¥è¢«æ›¿æ¢çš„å…ƒç´  lastElement ä¸æ˜¯ valï¼Œåˆ™éœ€è¦æ›´æ–° lastElement çš„ç´¢å¼•
		if (removeIndex !== lastIndex) {
			const lastIndices = this.indicesMap.get(lastElement);
			lastIndices.delete(lastIndex);
			lastIndices.add(removeIndex); // æ›´æ–° lastElement åœ¨æ•°ç»„ä¸­çš„ä½ç½®
		}

		return true;
	}

	/**
	 * éšæœºè·å–ä¸€ä¸ªå…ƒç´ 
	 * @return {number} éšæœºè¿”å›é›†åˆä¸­çš„ä¸€ä¸ªå…ƒç´ 
	 */
	getRandom() {
		const randomIndex = Math.floor(Math.random() * this.elements.length);
		return this.elements[randomIndex];
	}
}

/**
 * Your RandomizedCollection object will be instantiated and called as such:
 * var obj = new RandomizedCollection()
 * var param_1 = obj.insert(val)
 * var param_2 = obj.remove(val)
 * var param_3 = obj.getRandom()
 */
```

## ç›¸å…³é¢˜ç›®

<!-- prettier-ignore -->
| é¢˜å· | æ ‡é¢˜ | é¢˜è§£ | æ ‡ç­¾ | éš¾åº¦ | åŠ›æ‰£ |
| :------: | :------ | :------: | :------ | :------: | :------: |
| 380 | O(1) æ—¶é—´æ’å…¥ã€åˆ é™¤å’Œè·å–éšæœºå…ƒç´  | [[âœ“]](/problem/0380.md) |  [`è®¾è®¡`](/tag/design.md) [`æ•°ç»„`](/tag/array.md) [`å“ˆå¸Œè¡¨`](/tag/hash-table.md) `2+` | ğŸŸ  | [ğŸ€„ï¸](https://leetcode.cn/problems/insert-delete-getrandom-o1) [ğŸ”—](https://leetcode.com/problems/insert-delete-getrandom-o1) |