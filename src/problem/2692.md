# [2692. ä½¿å¯¹è±¡ä¸å¯å˜ ğŸ”’](https://2xiao.github.io/leetcode-js/problem/2692.html)

ğŸŸ  <font color=#ffb800>Medium</font>&emsp; ğŸ”—&ensp;[`åŠ›æ‰£`](https://leetcode.cn/problems/make-object-immutable) [`LeetCode`](https://leetcode.com/problems/make-object-immutable)

## é¢˜ç›®

Write a function that takes an object `obj` and returns a new **immutable**
version of this object.

An **immutable **object is an object that can't be altered and will throw an
error if any attempt is made to alter it.

There are three types of error messages that can be produced from this new
object.

- Attempting to modify a key on the object will result in this error message: `Error Modifying: ${key}`.
- Attempting to modify an index on an array will result in this error message: `Error Modifying Index: ${index}`.
- Attempting to call a method that mutates an array will result in this error message: `Error Calling Method: ${methodName}`. You may assume the only methods that can mutate an array are `['pop', 'push', 'shift', 'unshift', 'splice', 'sort', 'reverse']`.

`obj` is a valid JSON object or array, meaning it is the output of
`JSON.parse()`.

Note that a string literal should be thrown, not an `Error`.

**Example 1:**

Input:

    obj = { "x": 5 }

    fn = (obj) => {
      obj.x = 5;
      return obj.x;
    }

Output:

    {"value": null, "error": "Error Modifying: x"}

Explanation: Attempting to modify a key on an object resuts in a thrown error. Note that it doesn't matter that the value was set to the same value as it was before.

**Example 2:**

Input:

    obj = [1, 2, 3]

    fn = (arr) => {
      arr[1] = {};
      return arr[2];
    }

Output:

    {"value": null, "error": "Error Modifying Index: 1"}

Explanation: Attempting to modify an array results in a thrown error.

**Example 3:**

Input:

    obj = { "arr": [1, 2, 3] }

    fn = (obj) => {
      obj.arr.push(4);
      return 42;
    }

Output:

    { "value": null, "error": "Error Calling Method: push"}

Explanation: Calling a method that can result in a mutation results in a thrown error.

**Example 4:**

Input:

    obj = { "x": 2, "y": 2 }

    fn = (obj) => {
      return Object.keys(obj);
    }

Output:

    {"value": ["x", "y"], "error": null}

Explanation: No mutations were attempted so the function returns as normal.

**Constraints:**

- `obj` is a valid JSON object or array
- `2 <= JSON.stringify(obj).length <= 10^5`

## é¢˜ç›®å¤§æ„

è¯·ä½ ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªå¯¹è±¡ `obj` ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡çš„ä¸€ä¸ªæ–°çš„ **ä¸å¯å˜** ç‰ˆæœ¬ã€‚

**ä¸å¯å˜** å¯¹è±¡æ˜¯æŒ‡ä¸èƒ½è¢«ä¿®æ”¹çš„å¯¹è±¡ï¼Œå¦‚æœè¯•å›¾ä¿®æ”¹å®ƒï¼Œåˆ™ä¼šæŠ›å‡ºé”™è¯¯ã€‚

æ­¤æ–°å¯¹è±¡å¯èƒ½äº§ç”Ÿä¸‰ç§ç±»å‹çš„é”™è¯¯æ¶ˆæ¯ã€‚

- å¦‚æœè¯•å›¾ä¿®æ”¹å¯¹è±¡çš„é”®ï¼Œåˆ™ä¼šäº§ç”Ÿä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š `Error Modifying: ${key}` ã€‚
- å¦‚æœè¯•å›¾ä¿®æ”¹æ•°ç»„çš„ç´¢å¼•ï¼Œåˆ™ä¼šäº§ç”Ÿä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š `Error Modifying Index: ${index}` ã€‚
- å¦‚æœè¯•å›¾è°ƒç”¨ä¼šæ”¹å˜æ•°ç»„çš„æ–¹æ³•ï¼Œåˆ™ä¼šäº§ç”Ÿä»¥ä¸‹é”™è¯¯æ¶ˆæ¯ï¼š `Error Calling Method: ${methodName}` ã€‚ä½ å¯ä»¥å‡è®¾åªæœ‰ä»¥ä¸‹æ–¹æ³•èƒ½å¤Ÿæ”¹å˜æ•°ç»„ï¼š `['pop', 'push', 'shift', 'unshift', 'splice', 'sort', 'reverse']` ã€‚

`obj` æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ JSON å¯¹è±¡æˆ–æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯ `JSON.parse()` çš„è¾“å‡ºç»“æœã€‚

è¯·æ³¨æ„ï¼Œåº”è¯¥æŠ›å‡ºå­—ç¬¦ä¸²å­—é¢é‡ï¼Œè€Œä¸æ˜¯ `Error` å¯¹è±¡ã€‚

**æç¤ºï¼š**

- `2 <= JSON.stringify(obj).length <= 10^5`

## è§£é¢˜æ€è·¯

è¦åˆ›å»ºä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡ï¼Œè¿™æ„å‘³ç€è¯¥å¯¹è±¡åŠå…¶åµŒå¥—å¯¹è±¡åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½è¢«ä¿®æ”¹ï¼Œå¦‚æœå°è¯•ä¿®æ”¹å¯¹è±¡çš„é”®ã€æ•°ç»„çš„ç´¢å¼•æˆ–è°ƒç”¨æ”¹å˜æ•°ç»„çŠ¶æ€çš„æ–¹æ³•ï¼Œåº”è¯¥æŠ›å‡ºç›¸åº”çš„é”™è¯¯æ¶ˆæ¯ã€‚

åˆ©ç”¨ JavaScript çš„ `Proxy` ç‰¹æ€§ï¼Œå¯ä»¥åœ¨å¯¹è±¡æˆ–æ•°ç»„çš„è®¿é—®å’Œä¿®æ”¹æ“ä½œä¸Šè¿›è¡Œæ‹¦æˆªï¼Œä»è€Œå®ç°ä¸å¯å˜æ€§ã€‚

1. **ä½¿ç”¨ `Proxy` è¿›è¡Œæ‹¦æˆª**ï¼š

   - ä¸ºå¯¹è±¡å’Œæ•°ç»„åˆ†åˆ«å®šä¹‰ä¸åŒçš„å¤„ç†å™¨ï¼ˆhandlerï¼‰ï¼š
     - **å¯¹è±¡å¤„ç†å™¨**ï¼šæ‹¦æˆªé”®çš„ä¿®æ”¹ï¼ŒæŠ›å‡º `"Error Modifying: ${key}"`ã€‚
     - **æ•°ç»„å¤„ç†å™¨**ï¼šæ‹¦æˆªç´¢å¼•çš„ä¿®æ”¹ï¼ŒæŠ›å‡º `"Error Modifying Index: ${index}"`ï¼ŒåŒæ—¶ä¸ºæ”¹å˜æ•°ç»„çš„æ–¹æ³•ï¼ˆå¦‚ `pop`, `push` ç­‰ï¼‰æä¾›ä»£ç†ï¼ŒæŠ›å‡º `"Error Calling Method: ${methodName}"`ã€‚

2. **é€’å½’å¤„ç†åµŒå¥—å¯¹è±¡**ï¼š

   - å¯¹è¾“å…¥å¯¹è±¡è¿›è¡Œé€’å½’éå†ï¼Œå¦‚æœå‘ç°ä¸€ä¸ªå±æ€§æ˜¯å¯¹è±¡æˆ–æ•°ç»„ï¼Œå°±é€’å½’è°ƒç”¨åŒæ ·çš„å¤„ç†é€»è¾‘ï¼Œå°†å…¶è½¬æ¢ä¸ºä¸å¯å˜çš„ä»£ç†ã€‚

3. **è¿”å›ç»“æœ**ï¼š
   - è°ƒç”¨é€’å½’å‡½æ•°å¤„ç†è¾“å…¥çš„ `obj` å¹¶è¿”å›æœ€ç»ˆçš„ä¸å¯å˜å¯¹è±¡ã€‚

#### å¤æ‚åº¦åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**ï¼š`O(n)`ï¼Œå…¶ä¸­ `n` æ˜¯å¯¹è±¡çš„æ€»å±æ€§æ•°é‡ã€‚éœ€è¦é€’å½’éå†æ¯ä¸ªåµŒå¥—çš„å¯¹è±¡ã€‚
- **ç©ºé—´å¤æ‚åº¦**ï¼š`O(n)`ï¼Œéœ€è¦ä¸ºæ¯ä¸ªå¯¹è±¡åˆ›å»ºä»£ç†ï¼Œç©ºé—´å¤æ‚åº¦ä¸è¾“å…¥çš„å¯¹è±¡å¤§å°æˆæ­£æ¯”ã€‚

## ä»£ç 

```javascript
/**
 * @param {Object|Array} obj
 * @return {Object|Array}
 */
var makeImmutable = function (obj) {
	const mutableMethods = [
		'pop',
		'push',
		'shift',
		'unshift',
		'splice',
		'sort',
		'reverse'
	];

	const objectHandler = {
		set: (target, key) => {
			throw `Error Modifying: ${String(key)}`;
		}
	};

	const arrayHandler = {
		set: (target, key) => {
			if (typeof key === 'symbol' || isNaN(key)) {
				throw `Error Modifying: ${String(key)}`;
			}
			throw `Error Modifying Index: ${String(key)}`;
		}
	};

	const functionHandler = {
		apply: (target) => {
			throw `Error Calling Method: ${String(target.name)}`;
		}
	};

	const dfs = (obj) => {
		if (Array.isArray(obj)) {
			// å¤„ç†æ•°ç»„
			const proxyArray = new Proxy(obj, arrayHandler);
			mutableMethods.forEach((method) => {
				proxyArray[method] = new Proxy(function (...args) {
					return obj[method](...args);
				}, functionHandler);
			});
			return proxyArray;
		} else if (typeof obj === 'object' && obj !== null) {
			// å¤„ç†å¯¹è±¡
			const proxyObject = new Proxy(obj, objectHandler);
			for (const key in obj) {
				if (typeof obj[key] === 'object') {
					proxyObject[key] = dfs(obj[key]);
				}
			}
			return proxyObject;
		}
		// è¿”å›åŸºæœ¬ç±»å‹
		return obj;
	};

	// è°ƒç”¨é€’å½’å‡½æ•°
	return dfs(obj);
};
```

## ç›¸å…³é¢˜ç›®

<!-- prettier-ignore -->
| é¢˜å· | æ ‡é¢˜ | é¢˜è§£ | æ ‡ç­¾ | éš¾åº¦ |
| :------: | :------ | :------: | :------ | :------ |
| 2690 | [æ— ç©·æ–¹æ³•å¯¹è±¡ ğŸ”’](https://leetcode.com/problems/infinite-method-object) | [[âœ“]](/problem/2690.md) |  | <font color=#15bd66>Easy</font> |
| 2691 | [ä¸å¯å˜è¾…åŠ©å·¥å…· ğŸ”’](https://leetcode.com/problems/immutability-helper) | [[âœ“]](/problem/2691.md) |  | <font color=#ff334b>Hard</font> |