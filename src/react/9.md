# 9. æ¥å…¥æµ‹è¯•æ¡†æ¶

::: info æ‘˜è¦

- å®ç° test-utils
- æ¥å…¥æµ‹è¯•æ¡†æ¶
- ç¼–å†™æµ‹è¯•ç”¨ä¾‹

ç›¸å…³ä»£ç å¯åœ¨ [`git tag v1.9`](https://github.com/2xiao/my-react/tree/v1.9) æŸ¥çœ‹

:::

ä¹‹å‰æˆ‘ä»¬å®ç°äº† `npm link` å’Œ `vite serve demos` ä¸¤ç§è°ƒè¯•æ–¹å¼ï¼Œæœ¬èŠ‚æˆ‘ä»¬å°†å®ç°ç¬¬ä¸‰ç§è°ƒè¯•æ–¹å¼ -- æµ‹è¯•ç”¨ä¾‹ã€‚

## 1. å®ç° test-utils

`test-utils` æ˜¯ React æä¾›çš„ä¸€ä¸ª[å®˜æ–¹æµ‹è¯•å·¥å…·åº“](https://github.com/facebook/react/blob/main/packages/react-dom/src/test-utils/ReactTestUtils.js)ï¼Œç”¨äºå¸®åŠ©å¼€å‘è€…ç¼–å†™å’Œæ‰§è¡Œ React ç»„ä»¶çš„å•å…ƒæµ‹è¯•ã€‚è¯¥å·¥å…·åº“æä¾›äº†ä¸€ç»„ç”¨äºæµ‹è¯• React ç»„ä»¶çš„å·¥å…·å’Œå®ç”¨å‡½æ•°ï¼Œä½¿å¾—ç¼–å†™æµ‹è¯•å˜å¾—æ›´åŠ å®¹æ˜“å’Œé«˜æ•ˆã€‚

`test-utils` ä¸»è¦ç”¨äºæµ‹è¯• React ç»„ä»¶çš„æ¸²æŸ“å’Œè¡Œä¸ºï¼Œè€Œ React DOM æ˜¯è´Ÿè´£å¤„ç† React ç»„ä»¶çš„æ¸²æŸ“å’Œåº•å±‚ DOM æ“ä½œçš„æ ¸å¿ƒåº“ã€‚å› æ­¤å¯ä»¥å°†æµ‹è¯•å·¥å…·æ”¾åœ¨ react-dom åŒ…ä¸­ï¼Œä½¿å¾—æµ‹è¯•å·¥å…·ä¸æ¸²æŸ“è¿‡ç¨‹å¯†åˆ‡ç›¸å…³ï¼Œæ›´å®¹æ˜“ä¸ React DOM çš„åŠŸèƒ½é›†æˆã€‚

æ–°å»º `packages/react-dom/test-utils.ts` æ–‡ä»¶ï¼Œå®ƒå¯¹å¤–æš´éœ²ä¸€ä¸ª `renderIntoContainer` æ–¹æ³•ï¼Œç„¶ååœ¨ `scripts/rollup/react-dom.config.js` å¢åŠ  `test-utils.ts` çš„æ‰“åŒ…é…ç½®ï¼š

::: code-tabs

@tab test-utils.ts

```ts
// packages/react-dom/test-utils.ts
import { ReactElementType } from 'shared/ReactTypes';
import { createRoot } from 'react-dom/client';

export function renderIntoDocument(element: ReactElementType) {
	const div = document.createElement('div');
	return createRoot(div).render(element);
}
```

@tab react-dom.config.js

```ts
// scripts/rollup/react-dom.config.js
// ...
// test-utils
{
    input: `${pkgPath}/test-utils.ts`,
    output: [
        {
            file: `${pkgDistPath}/test-utils.js`,
            name: 'testUtils',
            format: 'umd'
        }
    ],
    externals: ['react-dom', 'react'],
    plugins: getBaseRollupPlugins()
}
```

:::

å†ç»™é¡¹ç›®å¢åŠ  babel ç¼–è¯‘ï¼Œå°† jsx ç¼–è¯‘æˆ javascriptã€‚

å…ˆå®‰è£… babel ç›¸å…³çš„åŒ…ï¼š

```bash
pnpm i -D -w @babel/core @babel/preset-env @babel/plugin-transform-react-jsx
```

- `@babel/core`ï¼š æ˜¯ Babel å·¥å…·é“¾çš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£æ•´ä½“çš„è½¬æ¢æµç¨‹å’Œå¯¹ä»£ç è¿›è¡Œ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è½¬æ¢ï¼›
- `@babel/preset-env`ï¼š æ˜¯ä¸€ä¸ª Babel é¢„è®¾ï¼ˆpresetï¼‰ï¼Œç”¨äºæ ¹æ®ç›®æ ‡ç¯å¢ƒï¼ˆæµè§ˆå™¨ã€Node.js ç­‰ï¼‰è‡ªåŠ¨ç¡®å®šéœ€è¦åº”ç”¨çš„è½¬æ¢æ’ä»¶ã€‚å®ƒæ ¹æ®é…ç½®ä¸­çš„ç›®æ ‡ç¯å¢ƒï¼Œé€‰æ‹©å¹¶å¯ç”¨ä¸€ç»„æ’ä»¶ï¼Œä»¥ç¡®ä¿ä»£ç èƒ½åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ­£å¸¸è¿è¡Œï¼›
- `@babel/plugin-transform-react-jsx`ï¼šæ˜¯ç”¨äºå°† JSX è¯­æ³•è½¬æ¢ä¸ºæ™®é€šçš„ JavaScript å‡½æ•°è°ƒç”¨çš„æ’ä»¶ã€‚JSX æ˜¯ React ä¸­ç”¨äºå£°æ˜ UI çš„è¯­æ³•ç³–ï¼Œè€Œè¿™ä¸ªæ’ä»¶ä½¿å¾—æµè§ˆå™¨æˆ– Node.js å¯ä»¥ç†è§£å¹¶æ‰§è¡Œ JSX è¯­æ³•ï¼›

ç„¶ååœ¨æ ¹ç›®å½•æ–°å»º `babel.config.js` æ–‡ä»¶ï¼Œé‡Œé¢æ˜¯ babel çš„é…ç½®ï¼š

```javascript
// babel.config.js
const { defaults } = require('jest-config');

module.exports = {
	...defaults,
	rootDir: process.cwd(),
	// å¯»æ‰¾æµ‹è¯•ç”¨ä¾‹å¿½ç•¥çš„æ–‡ä»¶å¤¹
	modulePathIgnorePatterns: ['<rootDir>/.history'],
	// ä¾èµ–åŒ…çš„è§£æåœ°å€
	moduleDirectories: [
		// React å’Œ ReactDOM åŒ…çš„åœ°å€
		'dist/node_modules',
		// ç¬¬ä¸‰æ–¹ä¾èµ–çš„åœ°å€
		...defaults.moduleDirectories
	],
	testEnvironment: 'jsdom'
};
```

## 2. æ¥å…¥æµ‹è¯•æ¡†æ¶

æµ‹è¯•ç¯å¢ƒä½¿ç”¨ [Jest](https://jestjs.io/) æµ‹è¯•æ¡†æ¶æ­å»ºï¼Œä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£… Jest åŠå…¶ç›¸å…³çš„åŒ…ï¼š

```bash
pnpm i -D -w jest
pnpm i -D -w jest-config
pnpm i -D -w jest-enviroment-jsdom
```

- `jest-config`ï¼šæä¾›äº† Jest çš„é»˜è®¤é…ç½®ï¼Œä»¥åŠä¸€äº›å¸¸ç”¨çš„é…ç½®é€‰é¡¹å’Œé¢„è®¾ï¼›
- `jest-enviroment-jsdom`ï¼šæä¾›äº†ä¸€ä¸ªä½¿ç”¨ jsdom å®ç°çš„æ¨¡æ‹Ÿ DOM ç¯å¢ƒï¼Œç”¨äºè¿è¡Œæµ‹è¯•æ—¶æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒï¼›

å†æ–°å»º `scripts/jest/jest.config.js` æ–‡ä»¶ï¼Œä¸º Jest æ·»åŠ é…ç½®å‚æ•°ï¼š

```javascript
// scripts/jest/jest.config.js
const { defaults } = require('jest-config');

module.exports = {
	...defaults,
	rootDir: process.cwd(),
	// å¯»æ‰¾æµ‹è¯•ç”¨ä¾‹å¿½ç•¥çš„æ–‡ä»¶å¤¹
	modulePathIgnorePatterns: ['<rootDir>/.history'],
	// ä¾èµ–åŒ…çš„è§£æåœ°å€
	moduleDirectories: [
		// React å’Œ ReactDOM åŒ…çš„åœ°å€
		'dist/node_modules',
		// ç¬¬ä¸‰æ–¹ä¾èµ–çš„åœ°å€
		...defaults.moduleDirectories
	],
	testEnvironment: 'jsdom'
};
```

å¹¶åœ¨ `package.json` çš„ `"scripts"` ä¸­å¢åŠ  jest çš„æ‰§è¡Œè„šæœ¬ï¼š

`"test": "jest --config scripts/jest/jest.config.js"`

è¿™æ—¶æ‰§è¡Œ `pnpm test` å°±å¯ä»¥è¿è¡Œ Jest è¿›è¡Œæµ‹è¯•ã€‚

## 3. ç¼–å†™æµ‹è¯•ç”¨ä¾‹

React å®˜æ–¹çš„æµ‹è¯•ç”¨ä¾‹éƒ½ä¿å­˜åœ¨ [`packages/react/src/__tests__/`](https://github.com/facebook/react/tree/main/packages/react/src/__tests__)ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å®ç°å‡ ä¸ª `ReactElement` çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæ–°å»º `packages/react/__tests__/ReactElement-test.js` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

::: details ğŸ‘‰ æŸ¥çœ‹ä»£ç  ğŸ‘ˆ

```javascript
// packages/react/__tests__/ReactElement-test.js
/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @emails react-core
 */

'use strict';

let React;
let ReactDOM;
let ReactTestUtils;

describe('ReactElement', () => {
	let ComponentFC;
	let originalSymbol;

	beforeEach(() => {
		jest.resetModules();

		// Delete the native Symbol if we have one to ensure we test the
		// unpolyfilled environment.
		originalSymbol = global.Symbol;
		global.Symbol = undefined;

		React = require('react');
		ReactDOM = require('react-dom');
		ReactTestUtils = require('react-dom/test-utils');

		// NOTE: We're explicitly not using JSX here. This is intended to test
		// classic JS without JSX.
		ComponentFC = () => {
			return React.createElement('div');
		};
	});

	afterEach(() => {
		global.Symbol = originalSymbol;
	});

	it('uses the fallback value when in an environment without Symbol', () => {
		expect((<div />).$$typeof).toBe(0xeac7);
	});

	it('returns a complete element according to spec', () => {
		const element = React.createElement(ComponentFC);
		expect(element.type).toBe(ComponentFC);
		expect(element.key).toBe(null);
		expect(element.ref).toBe(null);

		expect(element.props).toEqual({});
	});

	it('allows a string to be passed as the type', () => {
		const element = React.createElement('div');
		expect(element.type).toBe('div');
		expect(element.key).toBe(null);
		expect(element.ref).toBe(null);
		expect(element.props).toEqual({});
	});

	it('returns an immutable element', () => {
		const element = React.createElement(ComponentFC);
		expect(() => (element.type = 'div')).not.toThrow();
	});

	it('does not reuse the original config object', () => {
		const config = { foo: 1 };
		const element = React.createElement(ComponentFC, config);
		expect(element.props.foo).toBe(1);
		config.foo = 2;
		expect(element.props.foo).toBe(1);
	});

	it('does not fail if config has no prototype', () => {
		const config = Object.create(null, { foo: { value: 1, enumerable: true } });
		const element = React.createElement(ComponentFC, config);
		expect(element.props.foo).toBe(1);
	});

	it('extracts key and ref from the config', () => {
		const element = React.createElement(ComponentFC, {
			key: '12',
			ref: '34',
			foo: '56'
		});
		expect(element.type).toBe(ComponentFC);
		expect(element.key).toBe('12');
		expect(element.ref).toBe('34');
		expect(element.props).toEqual({ foo: '56' });
	});

	it('extracts null key and ref', () => {
		const element = React.createElement(ComponentFC, {
			key: null,
			ref: null,
			foo: '12'
		});
		expect(element.type).toBe(ComponentFC);
		expect(element.key).toBe('null');
		expect(element.ref).toBe(null);
		expect(element.props).toEqual({ foo: '12' });
	});

	it('ignores undefined key and ref', () => {
		const props = {
			foo: '56',
			key: undefined,
			ref: undefined
		};
		const element = React.createElement(ComponentFC, props);
		expect(element.type).toBe(ComponentFC);
		expect(element.key).toBe(null);
		expect(element.ref).toBe(null);
		expect(element.props).toEqual({ foo: '56' });
	});

	it('ignores key and ref warning getters', () => {
		const elementA = React.createElement('div');
		const elementB = React.createElement('div', elementA.props);
		expect(elementB.key).toBe(null);
		expect(elementB.ref).toBe(null);
	});

	it('coerces the key to a string', () => {
		const element = React.createElement(ComponentFC, {
			key: 12,
			foo: '56'
		});
		expect(element.type).toBe(ComponentFC);
		expect(element.key).toBe('12');
		expect(element.ref).toBe(null);
		expect(element.props).toEqual({ foo: '56' });
	});

	it('merges an additional argument onto the children prop', () => {
		const a = 1;
		const element = React.createElement(
			ComponentFC,
			{
				children: 'text'
			},
			a
		);
		expect(element.props.children).toBe(a);
	});

	it('does not override children if no rest args are provided', () => {
		const element = React.createElement(ComponentFC, {
			children: 'text'
		});
		expect(element.props.children).toBe('text');
	});

	it('overrides children if null is provided as an argument', () => {
		const element = React.createElement(
			ComponentFC,
			{
				children: 'text'
			},
			null
		);
		expect(element.props.children).toBe(null);
	});

	it('merges rest arguments onto the children prop in an array', () => {
		const a = 1;
		const b = 2;
		const c = 3;
		const element = React.createElement(ComponentFC, null, a, b, c);
		expect(element.props.children).toEqual([1, 2, 3]);
	});

	// // NOTE: We're explicitly not using JSX here. This is intended to test
	// // classic JS without JSX.
	it('allows static methods to be called using the type property', () => {
		function StaticMethodComponent() {
			return React.createElement('div');
		}
		StaticMethodComponent.someStaticMethod = () => 'someReturnValue';

		const element = React.createElement(StaticMethodComponent);
		expect(element.type.someStaticMethod()).toBe('someReturnValue');
	});

	// // NOTE: We're explicitly not using JSX here. This is intended to test
	// // classic JS without JSX.
	it('identifies valid elements', () => {
		function Component() {
			return React.createElement('div');
		}

		expect(React.isValidElement(React.createElement('div'))).toEqual(true);
		expect(React.isValidElement(React.createElement(Component))).toEqual(true);

		expect(React.isValidElement(null)).toEqual(false);
		expect(React.isValidElement(true)).toEqual(false);
		expect(React.isValidElement({})).toEqual(false);
		expect(React.isValidElement('string')).toEqual(false);
		expect(React.isValidElement(Component)).toEqual(false);
		expect(React.isValidElement({ type: 'div', props: {} })).toEqual(false);

		const jsonElement = JSON.stringify(React.createElement('div'));
		expect(React.isValidElement(JSON.parse(jsonElement))).toBe(true);
	});

	// // NOTE: We're explicitly not using JSX here. This is intended to test
	// // classic JS without JSX.
	it('is indistinguishable from a plain object', () => {
		const element = React.createElement('div', { className: 'foo' });
		const object = {};
		expect(element.constructor).toBe(object.constructor);
	});

	it('does not warn for NaN props', () => {
		function Test() {
			return <div />;
		}

		const test = ReactTestUtils.renderIntoDocument(<Test value={+undefined} />);
		expect(test.props.value).toBeNaN();
	});

	// // NOTE: We're explicitly not using JSX here. This is intended to test
	// // classic JS without JSX.
	it('identifies elements, but not JSON, if Symbols are supported', () => {
		// Rudimentary polyfill
		// @eslint-
		// Once all jest engines support Symbols natively we can swap this to test
		// WITH native Symbols by default.
		/*eslint-disable */
		const REACT_ELEMENT_TYPE = function () {}; // fake Symbol
		// eslint-disable-line no-use-before-define
		const OTHER_SYMBOL = function () {}; // another fake Symbol
		/*eslint-enable */
		global.Symbol = function (name) {
			return OTHER_SYMBOL;
		};
		global.Symbol.for = function (key) {
			if (key === 'react.element') {
				return REACT_ELEMENT_TYPE;
			}
			return OTHER_SYMBOL;
		};

		jest.resetModules();

		React = require('react');

		function Component() {
			return React.createElement('div');
		}

		expect(React.isValidElement(React.createElement('div'))).toEqual(true);
		expect(React.isValidElement(React.createElement(Component))).toEqual(true);

		expect(React.isValidElement(null)).toEqual(false);
		expect(React.isValidElement(true)).toEqual(false);
		expect(React.isValidElement({})).toEqual(false);
		expect(React.isValidElement('string')).toEqual(false);

		expect(React.isValidElement(Component)).toEqual(false);
		expect(React.isValidElement({ type: 'div', props: {} })).toEqual(false);

		const jsonElement = JSON.stringify(React.createElement('div'));
		expect(React.isValidElement(JSON.parse(jsonElement))).toBe(false);
	});
});
```

:::

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†æµ‹è¯•ç¯å¢ƒæ­å»ºï¼Œå¹¶ç¼–å†™äº† 20 ä¸ª ReactElement çš„æµ‹è¯•ç”¨ä¾‹ã€‚ç°åœ¨æ‰§è¡Œ `pnpm build-dev` æ‰“åŒ…æœ€æ–°ä»£ç ï¼Œå†æ‰§è¡Œ `pnpm test` å³å¯è¿è¡Œæµ‹è¯•ï¼Œå¦‚æœå‘ç°æµ‹è¯•ç”¨ä¾‹è¿è¡Œå¤±è´¥ï¼Œå¯ä»¥æŸ¥çœ‹æµ‹è¯•è¾“å‡ºä»¥è·å–å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹çš„è¯¦ç»†ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ªï¼Œç„¶ååˆ†æå‡ºç°é—®é¢˜çš„åŸå› ã€‚

æ­å»ºæµ‹è¯•ç¯å¢ƒã€ç¼–å†™æµ‹è¯•ç”¨ä¾‹ä»¥åŠå®šæœŸè¿è¡Œæµ‹è¯•ï¼Œå¯ä»¥å¸®å¼€å‘è€…å‘ç°ä»£ç ä¸­æ½œåœ¨çš„é—®é¢˜ï¼Œå¯¹äºæé«˜ä»£ç è´¨é‡ã€ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§æœ‰ç€ç§¯æçš„å½±å“ã€‚

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œå…³æ³¨æµ‹è¯•è¦†ç›–ç‡ã€è¿è¡Œæ—¶æ€§èƒ½ç­‰æ–¹é¢ä¹Ÿæ˜¯é‡è¦çš„ã€‚ä½¿ç”¨æŒç»­é›†æˆï¼ˆCIï¼‰å·¥å…·ï¼Œç¡®ä¿æµ‹è¯•åœ¨æ¯æ¬¡æäº¤æˆ–æ‹‰å–è¯·æ±‚æ—¶éƒ½èƒ½è¿è¡Œï¼Œæœ‰åŠ©äºåŠæ—¶å‘ç°é—®é¢˜ã€‚

ç›¸å…³ä»£ç å¯åœ¨ `git tag v1.9` æŸ¥çœ‹ï¼Œåœ°å€ï¼š[https://github.com/2xiao/my-react/tree/v1.9](https://github.com/2xiao/my-react/tree/v1.9)
