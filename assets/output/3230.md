# [3230. å®¢æˆ·è´­ä¹°è¡Œä¸ºåˆ†æ](https://leetcode.com/problems/customer-purchasing-behavior-analysis)

ğŸŸ  <font color=#ffb800>Medium</font>&emsp; ğŸ”–&ensp; [`æ•°æ®åº“`](/tag/database.md)&emsp; ğŸ”—&ensp;[`LeetCode`](https://leetcode.com/problems/customer-purchasing-behavior-analysis)

## é¢˜ç›®

Table: `Transactions`

> 
> 
> 
> 
> 
> +------------------+---------+
> 
> | Column Name> 
>   | Type> 
> |
> 
> +------------------+---------+
> 
> | transaction_id   | int> 
>  |
> 
> | customer_id> 
>   | int> 
>  |
> 
> | product_id> 
>    | int> 
>  |
> 
> | transaction_date | date> 
> |
> 
> | amount> 
> > 
>    | decimal |
> 
> +------------------+---------+
> 
> transaction_id is the unique identifier for this table.
> 
> Each row of this table contains information about a transaction, including the customer ID, product ID, date, and amount spent.
> 
> 

Table: `Products`

> 
> 
> 
> 
> 
> +-------------+---------+
> 
> | Column Name | Type> 
> |
> 
> +-------------+---------+
> 
> | product_id  | int> 
>  |
> 
> | category> 
> | varchar |
> 
> | price> 
>    | decimal |
> 
> +-------------+---------+
> 
> product_id is the unique identifier for this table.
> 
> Each row of this table contains information about a product, including its category and price.
> 
> 

Write a solution to analyze customer purchasing behavior. For **each
customer** , calculate:

  * The total amount spent.
  * The number of transactions.
  * The number of **unique** product categories purchased.
  * The average amount spent. 
  * The **most frequently** purchased product category (if there is a tie, choose the one with the most recent transaction).
  * A **loyalty score**  defined as: (Number of transactions * 10) + (Total amount spent / 100).

Round `total_amount`, `avg_transaction_amount`, and `loyalty_score` to `2`
decimal places.

Return _the result table ordered by_ `loyalty_score` _in**descending** order_,
_then by_`customer_id` _in**ascending** order_.

The query result format is in the following example.



**Example:**

**Input:**

`Transactions` table:

> 
> 
> 
> 
> 
> +----------------+-------------+------------+------------------+--------+
> 
> | transaction_id | customer_id | product_id | transaction_date | amount |
> 
> +----------------+-------------+------------+------------------+--------+
> 
> | 1> 
> > 
> > 
>   | 101> 
> > 
>  | 1> 
> > 
>   | 2023-01-01> 
>    | 100.00 |
> 
> | 2> 
> > 
> > 
>   | 101> 
> > 
>  | 2> 
> > 
>   | 2023-01-15> 
>    | 150.00 |
> 
> | 3> 
> > 
> > 
>   | 102> 
> > 
>  | 1> 
> > 
>   | 2023-01-01> 
>    | 100.00 |
> 
> | 4> 
> > 
> > 
>   | 102> 
> > 
>  | 3> 
> > 
>   | 2023-01-22> 
>    | 200.00 |
> 
> | 5> 
> > 
> > 
>   | 101> 
> > 
>  | 3> 
> > 
>   | 2023-02-10> 
>    | 200.00 |
> 
> +----------------+-------------+------------+------------------+--------+
> 
> 

`Products` table:

> 
> 
> 
> 
> 
> +------------+----------+--------+
> 
> | product_id | category | price  |
> 
> +------------+----------+--------+
> 
> | 1> 
> > 
>   | A> 
> > 
> | 100.00 |
> 
> | 2> 
> > 
>   | B> 
> > 
> | 150.00 |
> 
> | 3> 
> > 
>   | C> 
> > 
> | 200.00 |
> 
> +------------+----------+--------+
> 
> 

**Output:**

> 
> 
> 
> 
> 
> +-------------+--------------+-------------------+-------------------+------------------------+--------------+---------------+
> 
> | customer_id | total_amount | transaction_count | unique_categories | avg_transaction_amount | top_category | loyalty_score |
> 
> +-------------+--------------+-------------------+-------------------+------------------------+--------------+---------------+
> 
> | 101> 
> > 
>  | 450.00> 
>    | 3> 
> > 
> > 
> > 
>  | 3> 
> > 
> > 
> > 
>  | 150.00> 
> > 
> > 
> > 
>  | C> 
> > 
> > 
> | 34.50> 
> > 
>  |
> 
> | 102> 
> > 
>  | 300.00> 
>    | 2> 
> > 
> > 
> > 
>  | 2> 
> > 
> > 
> > 
>  | 150.00> 
> > 
> > 
> > 
>  | C> 
> > 
> > 
> | 23.00> 
> > 
>  |
> 
> +-------------+--------------+-------------------+-------------------+------------------------+--------------+---------------+
> 
> 

**Explanation:**

  * For customer 101: 
> 
> * Total amount spent: 100.00 + 150.00 + 200.00 = 450.00
> 
> * Number of transactions: 3
> 
> * Unique categories: A, B, C (3 categories)
> 
> * Average transaction amount: 450.00 / 3 = 150.00
> 
> * Top category: C (Customer 101 made 1 purchase each in categories A, B, and C. Since the count is the same for all categories, we choose the most recent transaction, which is category C on 2023-02-10)
> 
> * Loyalty score: (3 * 10) + (450.00 / 100) = 34.50
  * For customer 102: 
> 
> * Total amount spent: 100.00 + 200.00 = 300.00
> 
> * Number of transactions: 2
> 
> * Unique categories: A, C (2 categories)
> 
> * Average transaction amount: 300.00 / 2 = 150.00
> 
> * Top category: C (Customer 102 made 1 purchase each in categories A and C. Since the count is the same for both categories, we choose the most recent transaction, which is category C on 2023-01-22)
> 
> * Loyalty score: (2 * 10) + (300.00 / 100) = 23.00

**Note:** The output is ordered by loyalty_score in descending order, then by
customer_id in ascending order.


## é¢˜ç›®å¤§æ„

è¡¨ï¼š`Transactions`

> 
> 
> 
> 
> 
> +------------------+---------+
> 
> | Column Name> 
>   | Type> 
> |
> 
> +------------------+---------+
> 
> | transaction_id   | int> 
>  |
> 
> | customer_id> 
>   | int> 
>  |
> 
> | product_id> 
>    | int> 
>  |
> 
> | transaction_date | date> 
> |
> 
> | amount> 
> > 
>    | decimal |
> 
> +------------------+---------+
> 
> transaction_id æ˜¯è¿™å¼ è¡¨çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
> 
> è¿™å¼ è¡¨çš„æ¯ä¸€è¡ŒåŒ…å«ä¸€æ¬¡äº¤æ˜“çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®¢æˆ· IDï¼Œäº§å“ IDï¼Œæ—¥æœŸå’Œæ€»èŠ±è´¹ã€‚
> 
> 

è¡¨ï¼š`Products`

> 
> 
> 
> 
> 
> +-------------+---------+
> 
> | Column Name | Type> 
> |
> 
> +-------------+---------+
> 
> | product_id  | int> 
>  |
> 
> | category> 
> | varchar |
> 
> | price> 
>    | decimal |
> 
> +-------------+---------+
> 
> product_id æ˜¯è¿™å¼ è¡¨çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
> 
> è¿™å¼ è¡¨çš„æ¯ä¸€è¡ŒåŒ…å«ä¸€ä¸ªäº§å“çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ƒçš„åˆ†ç±»å’Œä»·æ ¼ã€‚
> 
> 

ç¼–å†™ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ¥åˆ†æç”¨æˆ·è´­ä¹°è¡Œä¸ºã€‚å¯¹äº **æ¯ä¸ªæ¶ˆè´¹è€…** ï¼Œè®¡ç®—ï¼š

  * æ€»æ¶ˆè´¹é¢
  * äº¤æ˜“æ•°é‡
  * è´­ä¹°çš„ **ä¸åŒ** äº§å“ç±»åˆ«çš„æ•°é‡ã€‚
  * å¹³å‡æ¶ˆè´¹é‡‘é¢ã€‚
  * **æœ€å¸¸è´­ä¹°** çš„äº§å“ç±»åˆ«ï¼ˆå¦‚æœç›¸åŒï¼Œé€‰æ‹©æœ€è¿‘äº¤æ˜“çš„é‚£ä¸ªï¼‰
  * **å¿ è¯šåº¦åˆ†æ•°** å®šä¹‰ä¸ºï¼š(äº¤æ˜“æ•°é‡ * 10) + (æ€»æ¶ˆè´¹ / 100)ã€‚

å°† `total_amount`ï¼Œ `avg_transaction_amount` å’Œ `loyalty_score` èˆå…¥åˆ° `2` ä½å°æ•°ã€‚

è¿”å›ç»“æœè¡¨ä»¥ `loyalty_score` **é™åº** æ’åºï¼Œç„¶åä»¥ _ _`customer_id` _ _**å‡åº** __ æ’åºã€‚

æŸ¥è¯¢ç»“æœæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚



**ç¤ºä¾‹ï¼š**

**è¾“å…¥ï¼š**

`Transactions` è¡¨ï¼š

> 
> 
> 
> 
> 
> +----------------+-------------+------------+------------------+--------+
> 
> | transaction_id | customer_id | product_id | transaction_date | amount |
> 
> +----------------+-------------+------------+------------------+--------+
> 
> | 1> 
> > 
> > 
>   | 101> 
> > 
>  | 1> 
> > 
>   | 2023-01-01> 
>    | 100.00 |
> 
> | 2> 
> > 
> > 
>   | 101> 
> > 
>  | 2> 
> > 
>   | 2023-01-15> 
>    | 150.00 |
> 
> | 3> 
> > 
> > 
>   | 102> 
> > 
>  | 1> 
> > 
>   | 2023-01-01> 
>    | 100.00 |
> 
> | 4> 
> > 
> > 
>   | 102> 
> > 
>  | 3> 
> > 
>   | 2023-01-22> 
>    | 200.00 |
> 
> | 5> 
> > 
> > 
>   | 101> 
> > 
>  | 3> 
> > 
>   | 2023-02-10> 
>    | 200.00 |
> 
> +----------------+-------------+------------+------------------+--------+
> 
> 

`Products` è¡¨ï¼š

> 
> 
> 
> 
> 
> +------------+----------+--------+
> 
> | product_id | category | price  |
> 
> +------------+----------+--------+
> 
> | 1> 
> > 
>   | A> 
> > 
> | 100.00 |
> 
> | 2> 
> > 
>   | B> 
> > 
> | 150.00 |
> 
> | 3> 
> > 
>   | C> 
> > 
> | 200.00 |
> 
> +------------+----------+--------+
> 
> 

**è¾“å‡ºï¼š**

> 
> 
> 
> 
> 
> +-------------+--------------+-------------------+-------------------+------------------------+--------------+---------------+
> 
> | customer_id | total_amount | transaction_count | unique_categories | avg_transaction_amount | top_category | loyalty_score |
> 
> +-------------+--------------+-------------------+-------------------+------------------------+--------------+---------------+
> 
> | 101> 
> > 
>  | 450.00> 
>    | 3> 
> > 
> > 
> > 
>  | 3> 
> > 
> > 
> > 
>  | 150.00> 
> > 
> > 
> > 
>  | C> 
> > 
> > 
> | 34.50> 
> > 
>  |
> 
> | 102> 
> > 
>  | 300.00> 
>    | 2> 
> > 
> > 
> > 
>  | 2> 
> > 
> > 
> > 
>  | 150.00> 
> > 
> > 
> > 
>  | C> 
> > 
> > 
> | 23.00> 
> > 
>  |
> 
> +-------------+--------------+-------------------+-------------------+------------------------+--------------+---------------+
> 
> 

**è§£é‡Šï¼š**

  * å¯¹äºæ¶ˆè´¹è€… 101ï¼š 
> 
> * æ€»æ¶ˆè´¹é¢ï¼š100.00 + 150.00 + 200.00 = 450.00
> 
> * äº¤æ˜“æ¬¡æ•°ï¼š3
> 
> * ä¸åŒåˆ†ç±»ï¼šA, B, C ï¼ˆ3 ä¸ªåˆ†ç±»ï¼‰
> 
> * å¹³å‡äº¤æ˜“é‡‘é¢ï¼š450.00 / 3 = 150.00
> 
> * æœ€é«˜åˆ†ç±»ï¼šC ï¼ˆæ¶ˆè´¹è€… 101 åœ¨åˆ†ç±» Aï¼ŒBï¼ŒC åˆ†åˆ«è¿›è¡Œäº†ä¸€æ¬¡äº¤æ˜“ã€‚å› ä¸ºæ‰€æœ‰åˆ†ç±»çš„æ•°é‡éƒ½ä¸€æ ·ï¼Œæˆ‘ä»¬é€‰æ‹©æœ€è¿‘çš„é‚£æ¬¡äº¤æ˜“ï¼Œå³åœ¨ 2023-02-10 çš„åˆ†ç±» Cï¼‰
> 
> * å¿ è¯šåº¦åˆ†æ•°ï¼š(3 * 10) + (450.00 / 100) = 34.50
  * å¯¹äºæ¶ˆè´¹è€… 102ï¼š 
> 
> * æ€»æ¶ˆè´¹é¢ï¼š100.00 + 200.00 = 300.00
> 
> * äº¤æ˜“æ¬¡æ•°ï¼š2
> 
> * ä¸åŒåˆ†ç±»ï¼šA, Cï¼ˆ2 ä¸ªåˆ†ç±»ï¼‰
> 
> * å¹³å‡äº¤æ˜“é‡‘é¢ï¼š300.00 / 2 = 150.00
> 
> * æœ€é«˜åˆ†ç±»ï¼šC ï¼ˆæ¶ˆè´¹è€… 102 åœ¨åˆ†ç±» A å’Œ C åˆ†åˆ«è¿›è¡Œäº†ä¸€æ¬¡äº¤æ˜“ã€‚å› ä¸ºæ‰€æœ‰åˆ†ç±»çš„æ•°é‡éƒ½ä¸€æ ·ï¼Œæˆ‘ä»¬é€‰æ‹©æœ€è¿‘çš„é‚£æ¬¡äº¤æ˜“ï¼Œå³åœ¨ 2023-01-22 çš„åˆ†ç±» Cï¼‰
> 
> * å¿ è¯šåº¦åˆ†æ•°ï¼š(2 * 10) + (300.00 / 100) = 23.00

**æ³¨æ„ï¼š** è¾“å‡ºè¡¨ä»¥ loyalty_score é™åºæ’åºï¼Œç„¶åä»¥ customer_id å‡åºæ’åºã€‚


## è§£é¢˜æ€è·¯

#### å¤æ‚åº¦åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**ï¼š`O()`ï¼Œ
- **ç©ºé—´å¤æ‚åº¦**ï¼š`O()`ï¼Œ

## ä»£ç 

```javascript

```